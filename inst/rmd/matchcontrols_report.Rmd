---
title: "Match Controls Results"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
  html_document:
    mathjax: null
    self_contained: true
    theme: simplex
    highlight: null
params:
  match_data: !r list()
  case_patientset_name: "None Given"
  controlpool_patientset_name: "None Given"
  
---

&nbsp;<p />
__Matching Cohorts__

Cohort                       Description
--------------------------   ----------------------------------------
Case Patients                `r params$case_patientset_name`
Control Pool Patients        `r params$controlpool_patientset_name`

&nbsp;<p />


```{r display_df, echo=FALSE, warning=FALSE, comment=NA, as.is=TRUE}

m<-params$match_data
vars <- m$match_variables

factor_variables <- names(which(sapply(m$match_data[, match_variables], 
                                         is.factor) == TRUE))

```

__Cohort Comparison (before matching)__

```{r prematching, echo=FALSE, warning=FALSE, comment=NA, as.is=TRUE, fig.width=10, fig.height=4}


tableone::CreateTableOne(vars = vars, strata = c("cohort"), data = m$match_data, factorVars = factor_variables)

plot_matchvars(d, vars)

```

&nbsp;<p />
__Matching Parameters__

Parameter                    Value
--------------------------   ----------------------------------------
Control-to-Case Ratio        `r m$controls_to_match`:1
Match Variables              `r m$match_variables`
Matching Technique           Coarsened exact matching (cem)

&nbsp;<p />

__Matching Results__

*Number of matching strata:* `r nrow(m$strata_summary)`<br />
*Number of strata with insufficient controls:* `r length(m$strata_summary)`
&nbsp;<p />
&nbsp;<p />

__Cohort Comparison (after matching)__

```{r postmatching, echo=FALSE, warning=FALSE, comment=NA, as.is=TRUE, fig.width=10, fig.height=4}

final.matched <- m$match_data %>% filter(cohort == "Case" | k2k_control == TRUE)

tableone::CreateTableOne(vars = m$match_variables, strata = c("cohort"), data = final.matched, factorVars = factor_variables)

plot_matchvars(final.matched, vars)

m$cem_result$imbalance$L1
```